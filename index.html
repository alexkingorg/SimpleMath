<!--

Copyright 2011 Alex King, All rights reserved.

TODO:

- styling
	- desktop
	- mobile
- ability to delete rows (cmd+delete to delete row as well as link)
- show row numbers
- auto-scroll rows up
- html storage to save page locally
- allow re-ordering of rows?

TEST:

- iPhone
- Android
- BlackBerry (6)

-->

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>SimpleMath</title>
</head>
<body>

<div class="equations">

<div class="equation" data-row="1">
	<p><input type="text" class="math"></p>
	<p>Result: <input type="text" class="result"></p>
</div>

</div>

<p><input type="button" name="new-eq" value="New" class="new-eq"></p>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" src="./js/jquery.caret.min.js"></script>
<script type="text/javascript">
$(function() {
	var keyUp = true;
	$('.equation .math').live('keydown', function(e) {
// handle insertion of values from previous lines
		keyUp = true;
		if (e.ctrlKey) {
			var row = e.keyCode - 48;
			if (row >= 0 && row <= 9) {
				$result = $('.equations .equation[data-row=' + row + '] .result');
				if ($result.size()) {
					var eq = $(this).val();
					var a = eq.substring(0, $(this).caret().start);
					var b = eq.substring($(this).caret().end, eq.length);
					var c = $result.val();
					var pos = ('' + a + c).length;
					$(this).val('' + a + c + b).caret({ start: pos, end: pos});
					$(this).trigger('calc');
					keyUp = false;
				}
			}
		}
	}).live('keyup', function(e) {
// do math
		if (!keyUp) {
			return;
		}
		$(this).trigger('calc');
// if key = enter, set focus to result and select for easy copying
		if (e.which === 13) {
			e.stopPropagation();
			$(this).closest('.equation').find('.result').focus().select();
		}
	}).live('calc', function() {
// simple math
		var val = null;
		var valError = '...';
		try {
			eval('val = ' + $(this).val().replace(/[^0-9 \.\)\(\+\-\*\/]+/g, '') + ';');
		}
		catch(err) {
			val = valError;
		}
		if (isNaN(val)) {
			val = valError;
		}
		$(this).closest('.equation').find('.result').val(val);
	}).filter(':first').focus();
	$('.equation .result').live('keyup', function(e) {
// auto-create new row
		if (e.which === 13) {
			e.stopPropagation();
			$('.new-eq').click();
		}
	});
	$('.new-eq').click(function() {
// create new row
		var $eqs = $('.equation');
		$('.equation:first').clone().find(':input').val('').end().appendTo('.equations');
		$('.equations').trigger('renumber').find('.equation:last :input:first').focus();
	});
	$('.equations').bind('renumber', function() {
// re-number rows
		var i = 0;
		var row = '';
		$($('.equation').get().reverse()).each(function() {
			if (i == 10) {
				row = 0;
			}
			else if (i >= 1 && i <= 9) {
				row = i;
			}
			else {
				row = '';
			}
			$(this).attr('data-row', row);
			i++;
		});
	});
});
</script>

</body>
</html>
